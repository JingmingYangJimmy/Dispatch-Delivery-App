

# Auth API

* **Base**：`/api/v1/auth`（迁移期若仍保留 `/auth`，两者都写，后续仅保留 `/api/v1/auth`）
* **Content-Type**：`application/json`
* **成功响应**：全局包装（ResponseBodyAdvice） →
  `{"status": <httpStatus>, "data": <payload>}`
* **错误响应**：统一 →
  `{"code":"SOME_CODE","message":"...","status":<httpStatus>}`

---

## A. 当前接口（按现有 DTO）

> 本节完全以**当前 DTO** 为准；示例仅展示结构，不包含所有业务字段校验细节。

### 1) 登录

* **POST** `/api/v1/auth/login`
* **Auth**：❌
* **Body（`LoginRequest`）**

```json
{ "email": "user@example.com", "password": "Str0ng!Pass" }
```

* **200（`TokenResponse`）**

```json
{
  "status": 200,
  "data": {
    "accessToken": "jwt-access",
    "refreshToken": "jwt-refresh",
    "expiresIn": 3600,
    "accessSid": "sid-xxxx"
  }
}
```

* **可能错误**：`BAD_CREDENTIALS(401)`, `BAD_REQUEST(400)`

---

### 2) 刷新令牌

* **POST** `/api/v1/auth/refresh`
* **Auth**：❌（用 refresh token）
* **Body（`RefreshRequest`）**

```json
{ "refreshToken": "jwt-refresh" }
```

* **200（`TokenResponse`）**：同上
* **可能错误**：`INVALID_TOKEN(401)`, `TOKEN_EXPIRED(401)`

---

### 3) 登出（当前会话）

* **POST** `/api/v1/auth/logout`
* **Auth**：✅
* **Body（`LogoutRequest`）**

```json
{ "accessSid": "sid-xxxx", "refreshToken": "optional-or-null" }
```

* **200**

```json
{ "status": 200, "data": {} }
```

---

### 4) 全部登出（当前用户所有会话）

* **POST** `/api/v1/auth/logout-all`
* **Auth**：✅
* **权限**：`SESSION_REVOKE_ALL`
* **Body（`LogoutAllRequest`）**

```json
{ "userId": 123 }
```

* **200**

```json
{ "status": 200, "data": {} }
```

> 服务内通常会 `TokenVersionStore.bump(userId)` 使旧 token 失效。

---

### 5) 请求**邮箱注册**验证码（两种传参方式兼容其一）

* **POST** `/api/v1/auth/signup/request-code`
* **Auth**：❌
* **Query（可选）**：`?email=user@example.com`
  **Body（可选）**：

```json
{ "email": "user@example.com" }
```

* **200**

```json
{ "status": 200, "data": {} }
```

* **可能错误**：`BAD_REQUEST(400)`, `EMAIL_IN_USE(409)`, `RATE_LIMITED(429)`

---

### 6) 确认注册（验证码 + 资料）

* **POST** `/api/v1/auth/signup/confirm`
  （兼容旧式 `POST /signup?code=123456`）
* **Auth**：❌
* **Query**：`code=123456`
* **Body（`RegisterBody`）**

```json
{
  "email": "user@example.com",
  "password": "Str0ng!Pass",
  "firstName": "Alice",
  "lastName": "Lee",
  "phone": "optional"
}
```

* **200（`TokenResponse`）**

```json
{ "status": 200, "data": { "accessToken": "...", "refreshToken": "...", "expiresIn": 3600, "accessSid": "sid-..." } }
```

* **可能错误**：`OTP_INVALID(400)`, `EMAIL_IN_USE(409)`

---

### 7) 创建邀请（后台/管理）

* **POST** `/api/v1/auth/invite`（或你的现有路径）
* **Auth**：✅
* **权限**：`INVITE_CREATE`
* **Body（`InviteCreateBody`）**

```json
{ "email": "invitee@example.com", "role": "CUSTOMER" }
```

* **200**

```json
{ "status": 200, "data": {} }
```

> 服务内通常生成 `inviteToken` 并发送邮件（或返回 token，视现有实现）。

---

## B. 最终接口（目标形态 / 对齐与扩展）

> 在不破坏当前代码的前提下，建议的**对齐与扩展**，便于后续加短信/双通道验证。

### 1) 登录

* **POST** `/api/v1/auth/login`
* **Body**

```json
{ "email": "string", "password": "string" }
```

* **200**

```json
{
  "status": 200,
  "data": {
    "accessToken": "string",
    "refreshToken": "string",
    "expiresIn": 3600,
    "accessSid": "string",
    "tokenType": "Bearer"
  }
}
```

---

### 2) 刷新令牌

* **POST** `/api/v1/auth/refresh`
* **Body**

```json
{ "refreshToken": "string" }
```

* **200**：同上

---

### 3) 登出（当前）

* **POST** `/api/v1/auth/logout`
* **Body**

```json
{ "accessSid": "string", "refreshToken": "string|null" }
```

* **200**：`{ "status": 200, "data": {} }`

---

### 4) 全部登出

* **POST** `/api/v1/auth/logout-all`
* **权限**：`SESSION_REVOKE_ALL`
* **Body**

```json
{ "userId": 123 }
```

* **200**：`{ "status": 200, "data": {} }`

---

### 5) 注册（两步）统一模型（兼容后续短信）

#### 5.1 请求验证码

* **POST** `/api/v1/auth/signup/request-code`
* **Body**

```json
{
  "channel": "email",             // 未来可 "sms"
  "email": "user@example.com"     // channel=sms 时为 phone
}
```

* **200**：`{ "status": 200, "data": {} }`

#### 5.2 确认注册

* **POST** `/api/v1/auth/signup/confirm`
* **Body**

```json
{
  "channel": "email",
  "code": "123456",
  "email": "user@example.com",
  "password": "Str0ng!Pass",
  "firstName": "Alice",
  "lastName": "Lee",
  "phone": "optional"
}
```

* **200**：返回 `TokenResponse` + `tokenType`（见上）

---

### 6) 邀请（两步）统一模型

#### 6.1 创建邀请（后台）

* **POST** `/api/v1/auth/invite`
* **权限**：`INVITE_CREATE`
* **Body**

```json
{ "email": "invitee@example.com", "role": "CUSTOMER" }
```

* **200**

```json
{ "status": 200, "data": { "inviteToken": "optional-return" } }
```

#### 6.2 请求邀请验证码

* **POST** `/api/v1/auth/invite/request-code`
* **Body**

```json
{ "token": "invite-token", "channel": "email" }
```

#### 6.3 确认邀请注册

* **POST** `/api/v1/auth/invite/confirm`
* **Body**

```json
{
  "token": "invite-token",
  "channel": "email",
  "code": "123456",
  "password": "Str0ng!Pass",
  "firstName": "Alice",
  "lastName": "Lee",
  "phone": "optional"
}
```

* **200**：返回 `TokenResponse` + `tokenType`

---

## C. 权限与鉴权（摘录）

* **认证**：`Authorization: Bearer <accessToken>`；过滤器校验 JWT、版本/黑名单/会话；`PermissionCacheSpring` 提供 `GrantedAuthority`。
* **路径级权限**（示例）：

```java
.requestMatchers(HttpMethod.POST, "/api/v1/auth/invite").hasAuthority("INVITE_CREATE")
.requestMatchers(HttpMethod.POST, "/api/v1/auth/logout-all").hasAuthority("SESSION_REVOKE_ALL")
```

* **错误**：缺权 → `{"code":"FORBIDDEN","message":"Access denied","status":403}`

---

## D. 常见错误码（节选）

| code            | status  | 说明       |
| --------------- | ------- | -------- |
| BAD_REQUEST     | 400     | 参数不合法/缺失 |
| BAD_CREDENTIALS | 401     | 邮箱或密码错误  |
| INVALID_TOKEN   | 401     | 令牌无效     |
| TOKEN_EXPIRED   | 401     | 令牌过期     |
| UNAUTHORIZED    | 401     | 未登录/鉴权失败 |
| FORBIDDEN       | 403     | 无权限      |
| NOT_FOUND       | 404     | 资源不存在    |
| EMAIL_IN_USE    | 409     | 邮箱已存在    |
| OTP_INVALID     | 400     | 验证码错误或过期 |
| INVITE_INVALID  | 400     | 邀请无效     |
| INVITE_EXPIRED  | 410/400 | 邀请过期     |
| RATE_LIMITED    | 429     | 频率限制     |
| INTERNAL_ERROR  | 500     | 服务器内部错误  |

---

### 备注

* “当前接口”中的请求/响应 **严格使用你上传的 DTO 字段**。
* “最终接口”是在不破坏当前使用的前提下，统一 `channel`、补充 `tokenType`，以及为短信扩展留口。
* 迁移策略：新旧端口/参数并存一段时间（别名路径），前端逐步切到“最终接口”，再清理旧用法。

